WITH PRODUCT_ALC_CLASS AS ( -- this with clause refers to the query in Listing 3-1
   SELECT
      PA.PRODUCT_ID
    , NTILE(2) OVER (
         ORDER BY PA.ABV, PA.PRODUCT_ID
      ) AS ALC_CLASS
   FROM PRACTICAL.PRODUCT_ALCOHOL PA
), CLASS_ONE_YEARLY_SALES AS ( -- this with clause refers to the query in Listing 3-2
   SELECT
      PAC.PRODUCT_ID AS P_ID
    , EXTRACT(YEAR FROM MS.MTH) AS YR
    , SUM(MS.QTY) AS YR_QTY
    , AVG(SUM(MS.QTY)) OVER (
         PARTITION BY PAC.PRODUCT_ID
      ) AS AVG_YR
   FROM PRODUCT_ALC_CLASS PAC
   JOIN PRACTICAL.MONTHLY_SALES MS
      ON MS.PRODUCT_ID = PAC.PRODUCT_ID
   WHERE PAC.ALC_CLASS = 1
   GROUP BY
      PAC.PRODUCT_ID
    , EXTRACT(YEAR FROM MS.MTH)
)
SELECT                        -- the final query refers to the query in Listing 3-3
   P_ID, YR, YR_QTY
 , ROUND(AVG_YR) AS AVG_YR
FROM CLASS_ONE_YEARLY_SALES
WHERE YR_QTY > AVG_YR
ORDER BY P_ID, YR;
--
--
/* PLAN_TABLE_OUTPUT */
 
--------------------------------------------------------------------------------------------
| Id  | Operation                | Name            | Rows  | Bytes | Cost (%CPU)| Time     |
--------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT         |                 |   255 | 13260 |     9  (34)| 00:00:01 |
|   1 |  SORT ORDER BY           |                 |   255 | 13260 |     9  (34)| 00:00:01 |
|*  2 |   VIEW                   |                 |   255 | 13260 |     8  (25)| 00:00:01 |
|   3 |    WINDOW BUFFER         |                 |   255 |  8160 |     8  (25)| 00:00:01 |
|   4 |     SORT GROUP BY        |                 |   255 |  8160 |     8  (25)| 00:00:01 |
|*  5 |      HASH JOIN           |                 |   360 | 11520 |     7  (15)| 00:00:01 |

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|*  6 |       VIEW               |                 |    10 |   170 |     4  (25)| 00:00:01 |
|   7 |        WINDOW SORT       |                 |    10 |    80 |     4  (25)| 00:00:01 |
|   8 |         TABLE ACCESS FULL| PRODUCT_ALCOHOL |    10 |    80 |     3   (0)| 00:00:01 |
|   9 |       TABLE ACCESS FULL  | MONTHLY_SALES   |   360 |  5400 |     3   (0)| 00:00:01 |
--------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   2 - filter("YR_QTY">"AVG_YR")
   5 - access("MS"."PRODUCT_ID"="PAC"."PRODUCT_ID")

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   6 - filter("PAC"."ALC_CLASS"=1)

23 rows selected. 
--
--
WITH PRODUCT_ALC_CLASS AS (
   SELECT
      PA.PRODUCT_ID
    , NTILE(2) OVER (
         ORDER BY PA.ABV, PA.PRODUCT_ID
      ) AS ALC_CLASS
   FROM PRACTICAL.PRODUCT_ALCOHOL PA
), YEARLY_SALES AS (
   SELECT
      MS.PRODUCT_ID
    , EXTRACT(YEAR FROM MS.MTH) AS YR
    , SUM(MS.QTY) AS YR_QTY
    , AVG(SUM(MS.QTY)) OVER (
         PARTITION BY MS.PRODUCT_ID
      ) AS AVG_YR
   FROM PRACTICAL.MONTHLY_SALES MS
   GROUP BY
      MS.PRODUCT_ID
    , EXTRACT(YEAR FROM MS.MTH)
)
SELECT
   PAC.PRODUCT_ID AS P_ID
 , YS.YR
 , YS.YR_QTY
 , ROUND(YS.AVG_YR) AS AVG_YR
FROM PRODUCT_ALC_CLASS PAC
JOIN YEARLY_SALES YS
   ON YS.PRODUCT_ID = PAC.PRODUCT_ID
WHERE PAC.ALC_CLASS = 1
AND YS.YR_QTY > YS.AVG_YR
ORDER BY P_ID, YR;
--
--
/* PLAN_TABLE_OUTPUT */
 
------------------------------------------------------------------------------------------
| Id  | Operation              | Name            | Rows  | Bytes | Cost (%CPU)| Time     |
------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT       |                 |   255 | 15300 |     9  (34)| 00:00:01 |
|   1 |  SORT ORDER BY         |                 |   255 | 15300 |     9  (34)| 00:00:01 |
|*  2 |   HASH JOIN            |                 |   255 | 15300 |     8  (25)| 00:00:01 |
|*  3 |    VIEW                |                 |    10 |   170 |     4  (25)| 00:00:01 |
|   4 |     WINDOW SORT        |                 |    10 |    80 |     4  (25)| 00:00:01 |
|   5 |      TABLE ACCESS FULL | PRODUCT_ALCOHOL |    10 |    80 |     3   (0)| 00:00:01 |

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|*  6 |    VIEW                |                 |   255 | 10965 |     4  (25)| 00:00:01 |
|   7 |     WINDOW BUFFER      |                 |   255 |  3825 |     4  (25)| 00:00:01 |
|   8 |      SORT GROUP BY     |                 |   255 |  3825 |     4  (25)| 00:00:01 |
|   9 |       TABLE ACCESS FULL| MONTHLY_SALES   |   360 |  5400 |     3   (0)| 00:00:01 |
------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   2 - access("YS"."PRODUCT_ID"="PAC"."PRODUCT_ID")
   3 - filter("PAC"."ALC_CLASS"=1)

PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   6 - filter("YS"."YR_QTY">"YS"."AVG_YR")